# .github/workflows/security-checks.yml
# Security checks workflow (referenced by main workflow)
# Implements SAST and secrets scanning per .cicdrules.md

name: Security Checks

on:
  workflow_call:

jobs:
  sast:
    name: Static Application Security Testing (SAST)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Run Bandit (Python SAST)
        uses: tj-actions/bandit@v5
        with:
          targets: .
          options: --severity-level medium
        # Fails only if medium or higher severity issues are found

  secrets-scan:
    name: Scan for Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Run Gitleaks secrets scan
        uses: gitleaks/gitleaks-action@v2
        with:
          fail: true
        # Fails if secrets are found

  prowler:
    name: AWS Security Best Practices (Prowler)
    # Prowler is an open-source Cloud Security Posture Management (CSPM) tool for AWS
    runs-on: ubuntu-latest
    needs: [sast, secrets-scan]
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Run Prowler (CSPM)
        run: |
          docker run --rm -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_REGION=us-east-1 prowler/prowler:latest -M json,csv,html -S critical
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
        # Fails if any critical findings are detected. Requires AWS credentials with least-privilege read access.

# This workflow can be triggered from other workflows using 'uses: ./.github/workflows/security-checks.yml'
